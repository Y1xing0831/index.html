<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>D&D Adventure Hub</title>
    <style>
        :root { --primary: #4a90e2; --bg: #f0f2f5; --card: #ffffff; --text: #2c3e50; }
        body { font-family: 'Segoe UI', system-ui; background: var(--bg); margin: 0; padding-bottom: 70px; }
        
        /* 主選單 */
        nav { 
            background: #2c3e50; color: white; display: flex; 
            overflow-x: auto; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        nav div { padding: 15px 20px; cursor: pointer; flex-shrink: 0; font-weight: bold; font-size: 0.9rem; }
        nav div.active { background: var(--primary); border-bottom: 3px solid white; }

        .page { display: none; padding: 15px; max-width: 500px; margin: auto; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card); padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 15px; }
        h2 { font-size: 1.1rem; color: var(--primary); margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .data-text { white-space: pre-wrap; font-size: 0.9rem; color: #555; line-height: 1.5; }
        
        /* 擲骰專區 */
        .dice-tray { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; min-height: 80px; margin: 15px 0; }
        .dice { width: 50px; height: 50px; background: #2c3e50; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; }
        .shape-20 { clip-path: polygon(50% 0%, 95% 25%, 95% 75%, 50% 100%, 5% 75%, 5% 25%); }
        button.roll-btn { background: var(--primary); color: white; border: none; width: 100%; padding: 15px; border-radius: 10px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<nav id="navbar">
    <div onclick="switchPage('dice')" class="active">擲骰</div>
    <div onclick="switchPage('char')">角色</div>
    <div onclick="switchPage('world')">世界</div>
    <div onclick="switchPage('quest')">任務</div>
    <div onclick="switchPage('party')">隊友</div>
</nav>

<div id="dice" class="page active">
    <div class="card">
        <div style="display: flex; gap: 10px;">
            <select id="diceType" style="flex:1; padding: 10px;">
                <option value="20">D20</option><option value="6">D6</option><option value="8">D8</option><option value="10">D10</option><option value="12">D12</option><option value="4">D4</option>
            </select>
            <input type="number" id="diceCount" value="1" style="width: 60px; padding: 10px;">
        </div>
        <div id="tray" class="dice-tray"></div>
        <button class="roll-btn" onclick="runRoll()">ROLL DICE</button>
        <h3 id="total-banner" style="text-align: center; opacity: 0;">Total: 0</h3>
    </div>
</div>

<div id="char" class="page">
    <div class="card">
        <h2 id="d-Name">角色加載中...</h2>
        <div class="data-text" id="d-RaceClass">讀取資料中...</div>
        <div class="data-text" id="d-LevelEXP"></div>
    </div>
    <div class="card">
        <h2>核心屬性 & 戰鬥</h2>
        <div class="data-text" id="d-Attributes"></div>
        <div class="data-text" id="d-HP_AC"></div>
    </div>
    <div class="card">
        <h2>技能、法術與清單</h2>
        <div class="data-text" id="d-Spells"></div>
        <hr>
        <div class="data-text" id="d-Inventory"></div>
    </div>
</div>

<div id="world" class="page">
    <div class="card"><h2>主要地區與城鎮</h2><div class="data-text" id="d-Regions"></div><div class="data-text" id="d-Towns"></div></div>
    <div class="card"><h2>主要 NPC</h2><div class="data-text" id="d-NPCs"></div></div>
</div>

<div id="quest" class="page">
    <div class="card"><h2>當前位置</h2><div class="data-text" id="d-Location"></div></div>
    <div class="card"><h2>任務狀態</h2><b>主線：</b><div class="data-text" id="d-Main"></div><br><b>支線：</b><div class="data-text" id="d-Current"></div></div>
</div>

<div id="party" class="page">
    <div class="card"><h2>隊伍成員</h2><div class="data-text" id="d-Members"></div></div>
</div>

<script>
    const GOOGLE_URL = 'https://script.google.com/macros/s/AKfycbyBI7TAjMQ0fuXluamUxbRrCAXCzmaxkODIix9QJI6Oi7OnD5LhGf-U_RxQgo8Z1CqtYg/exec';

    function switchPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('nav div').forEach(d => d.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
        if(id !== 'dice') refreshData();
    }

    async function refreshData() {
        try {
            const res = await fetch(GOOGLE_URL);
            const data = await res.json();
            // 自動填充所有 ID 開頭為 d- 的元素
            for (let sheet in data) {
                for (let item in data[sheet]) {
                    const el = document.getElementById('d-' + item);
                    if (el) el.innerText = data[sheet][item];
                }
            }
        } catch (e) { console.error("Load Error"); }
    }

    function runRoll() {
        const type = document.getElementById('diceType').value;
        const count = document.getElementById('diceCount').value;
        const tray = document.getElementById('tray');
        tray.innerHTML = '';
        let results = [];
        let total = 0;
        for(let i=0; i<count; i++) {
            const val = Math.floor(Math.random() * type) + 1;
            results.push(val); total += val;
            const d = document.createElement('div');
            d.className = `dice shape-${type}`;
            d.innerText = val;
            tray.appendChild(d);
        }
        document.getElementById('total-banner').innerText = "Total: " + total;
        document.getElementById('total-banner').style.opacity = 1;
        fetch(GOOGLE_URL, {
            method: 'POST',
            body: JSON.stringify({ targetSheet: "CurrentRoll", combo: count + "D" + type, list: results.join(", ") })
        });
    }
</script>
</body>
</html>
